#!/bin/bash
####################################################################################################################################################################
# UTILITY FUNCTIONS
####################################################################################################################################################################
secho() { # The "echo" builtin should not be used with arbitrary strings since it does not support termination of the parameter list
    printf '%s\n' "$*"
}

stdout() {
    secho "$@" >&1
}

stderr() {
    secho "$@" >&2
}

die() {
    stderr 'ERROR:' "$@"
    exit 1
}

err_handler() {
    die "error at line $1, last exit code is $2" 
}
####################################################################################################################################################################


####################################################################################################################################################################
# SHELL PARAMETERS
####################################################################################################################################################################
set -o nounset
set -o pipefail
set -o errexit
set -o errtrace
shopt -s nullglob
shopt -s failglob
trap 'err_handler "$LINENO" "$?"' ERR
####################################################################################################################################################################


####################################################################################################################################################################
# GLOBALS
####################################################################################################################################################################
HOSTS=
HOST_SELF=
HADOOP_DIR=./hadoop
HADOOP_MASTER_LIST="$HADOOP_DIR/conf/masters"
HADOOP_SLAVE_LIST="$HADOOP_DIR/conf/slaves"
####################################################################################################################################################################


####################################################################################################################################################################
# THE ACTUAL CODE
####################################################################################################################################################################

main() {
    get_hosts

    stdout "Machines: ${HOSTS[@]}"
    stdout "Own machine: $SELF"

    remove_host "$SELF"
    stdout "Machines without own: ${HOSTS[@]}"

    # Truncate masters file:
    # The local machine is automatically selected as master.
    # The purpose of the masters-list would be to add SECONDARY namenodes / jobtrackers - which we don't want.
    > "$HADOOP_MASTER_LIST"

    # Set all hosts except ourself as slave
    > "$HADOOP_SLAVE_LIST"
    for host in "${HOSTS[@]}" ; do
	stdout "$host" >> "$HADOOP_SLAVE_LIST"
    done
}

get_hosts() {
    # Get all hosts of the LSF job
    read -ra HOSTS <<< "$LSB_HOSTS"
    # Get host where this script is running
    SELF="$(hostname --short)" # --short removes the domain name, which get_hosts_sorted won't include
}

remove_host() {
    local to_remove="$1"
    local new_hosts=( )

    for host in "${HOSTS[@]}" ; do
	[ "$host" != "$to_remove" ] && new_hosts+=( "$host" )
    done

    HOSTS=( "${new_hosts[@]}" )
}

main "$@"

####################################################################################################################################################################